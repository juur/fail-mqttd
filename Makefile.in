SHELL = /bin/sh

srcdir := @@SRCDIR@@
objdir := @@OBJDIR@@

.SUFFIXES:
.SUFFIXES: .c .o

DESTDIR         :=
CC              := @@CC@@
CXX             := @@CXX@@
LEX             := @@LEX@@
YACC		    := @@YACC@@
LFLAGS          := @@LFLAGS@@
YFLAGS          := -d -t @@YFLAGS@@
CFLAGS          := -std=c2x @@CFLAGS@@
CPPFLAGS        := -DNDEBUG @@CPPFLAGS@@
LDFLAGS         := -L$(srcdir)/src -L$(objdir) -L. @@LDFLAGS@@
CAT             := cat
CP              := cp
TAR             := tar
RM              ?= rm -f
MKDIR           := mkdir -p
PKGCONFIG       := pkg-config
VERSION         := $(shell $(CAT) "$(srcdir)/misc/VERSION")
PACKAGE         := $(shell $(CAT) "$(srcdir)/misc/PACKAGE")
HELP2MAN		:= help2man
DEPS			:= @@DEPS@@

bindir         := @@BINDIR@@
datadir        := @@DATADIR@@
datarootdir    := @@DATAROOTDIR@@
docdir         := @@DOCDIR@@
exec_prefix    := @@EXECPREFIX@@
infodir        := @@INFODIR@@
libdir         := @@LIBDIR@@
libexecdir     := @@LIBEXECDIR@@
localedir      := @@LOCALEDIR@@
localstatedir  := @@LOCALSTATEDIR@@
mandir         := @@MANDIR@@
prefix         := @@PREFIX@@
runstatedir    := @@RUNSTATEDIR@@
sbindir        := @@SBINDIR@@
sharedstatedir := @@SHAREDSTATEDIR@@
sysconfdir     := @@SYSCONFDIR@@
progprefix     := @@PROGPREFIX@@

main_SRCS    := main.c constants.c
raft_SRCS    := raft.c raft_impl.c raft_constants.c
test_SRCS    := $(wildcard $(srcdir)/tests/test-*.c)

all_SRCS     := $(main_SRCS) @@EXTRASRCS@@
all_SRCS     := $(addprefix $(srcdir)/src/,$(all_SRCS))

all_HEADERS  := $(wildcard $(srcdir)/src/*.h)
package_OBJS := $(addprefix $(objdir)/,$(notdir $(all_SRCS:.c=.o)))
test_OBJS    := $(patsubst $(srcdir)/tests/%.c,$(objdir)/%.o,$(test_SRCS))
test_BINS    := $(patsubst $(srcdir)/tests/%.c,$(objdir)/%,$(test_SRCS))

CHECK_CFLAGS := @@CHECK_CFLAGS@@
CHECK_LIBS   := @@CHECK_LIBS@@

ifeq ($(DEPS),1)
CPPFLAGS += -MMD -MP
endif
CPPFLAGS += -I$(objdir) -I$(srcdir)/src
CPPFLAGS += -I$(srcdir)/include

.PHONY: all check test
all: $(objdir)/.d $(objdir)/$(progprefix)$(PACKAGE) $(objdir)/$(PACKAGE).8

check: $(test_BINS)
	@set -e; for t in $(test_BINS); do \
		echo "RUN $$t"; \
		$$t; \
	done

test: check

$(objdir)/.d:
	@mkdir -p $(objdir)/.d 2>/dev/null

$(objdir)/$(PACKAGE).8: $(objdir)/$(progprefix)$(PACKAGE)
	-$(HELP2MAN) -N -s 8 -S 'ZeroDay Linux' --help-option=-h --version-option=-V -o $@ $<

$(objdir)/$(progprefix)$(PACKAGE): $(package_OBJS)
	$(CC) $(package_OBJS) $(LDFLAGS) -o $@


.PHONY: install uninstall

install: $(PACKAGE)
	$(MKDIR) $(DESTDIR)$(sbindir)
	$(MKDIR) $(DESTDIR)$(localstatedir)/fail-mqttd
	$(MKDIR) $(DESTDIR)$(mandir)/man8
	$(CP) $(objdir)/$(progprefix)$(PACKAGE) $(DESTDIR)$(sbindir)/
	$(CP) $(objdir)/$(PACKAGE).8 $(DESTDIR)$(mandir)/man8/

uninstall:
	$(RM) $(DESTDIR)$(sbindir)/$(PACKAGE)
	$(RM) $(DESTDIR)$(mandir)/man8/$(PACKAGE).8

.PHONY: mostlyclean clean distclean maintainer-clean

maintainer-clean: distclean
	$(RM) $(objdir)/config.status $(objdir)/config.log

distclean: clean
	$(RM) $(objdir)/config.h $(objdir)/Makefile $(objdir)/fail-mqttd.spec \
		$(objdir)/fail-mqttd.service

mostlyclean:
	$(RM) $(package_OBJS) $(objdir)/$(PACKAGE)

clean: mostlyclean
	$(RM) $(objdir)/$(PACKAGE).8
	$(RM) -rf $(objdir)/.d/*

dist:
	pushd $(srcdir) >/dev/null ; \
	$(TAR) -acf $(objdir)/$(PACKAGE)-$(VERSION).tar.xz \
		--transform="s,^./,,;s,^,$(PACKAGE)-$(VERSION)/," \
		README.md COPYING src misc Makefile.in configure include SECURITY.md \
		$(PACKAGE).spec{,.in} $(PACKAGE).service{,.in} ; \
	popd >/dev/null

$(objdir)/%.o: $(srcdir)/src/%.c
ifeq ($(DEPS),1)
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -MF $(objdir)/.d/$*.d $< -o $@
else
	$(CC) -c $(CFLAGS) $(CPPFLAGS) $< -o $@
endif

$(objdir)/%.o: $(srcdir)/tests/%.c
	$(CC) -c $(CFLAGS) $(CPPFLAGS) $(CHECK_CFLAGS) $< -o $@

$(objdir)/test-%: $(objdir)/test-%.o
	$(CC) $(objdir)/test-$*.o $(LDFLAGS) $(CHECK_LIBS) -o $@

ifeq ($(DEPS),1)
-include $(all_SRCS:$(srcdir)/src/%.c=$(objdir)/.d/%.d)
endif
