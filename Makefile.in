SHELL = /bin/sh

srcdir := @@SRCDIR@@
objdir := @@OBJDIR@@

.SUFFIXES:
.SUFFIXES: .c .o

DESTDIR          :=
CC               := @@CC@@
CXX              := @@CXX@@
LEX              := @@LEX@@
YACC             := @@YACC@@
LFLAGS           := @@LFLAGS@@
YFLAGS           := -d -t @@YFLAGS@@
CFLAGS           := -std=c2x @@CFLAGS@@ @@SANITIZE_CFLAGS@@
CPPFLAGS         := -DNDEBUG @@CPPFLAGS@@
LDFLAGS          := -L$(srcdir)/src -L$(objdir) -L. @@LDFLAGS@@ @@SANITIZE_LDFLAGS@@
CHECK_CFLAGS     := @@CHECK_CFLAGS@@
CHECK_LIBS       := @@CHECK_LIBS@@
CAT              ?= cat
CP               ?= cp
TAR              ?= tar
RM               ?= rm -f
RMDIR            ?= rmdir
MKDIR            ?= mkdir -p
PKGCONFIG        ?= pkg-config
VERSION          := $(shell $(CAT) "$(srcdir)/misc/VERSION")
PACKAGE          := $(shell $(CAT) "$(srcdir)/misc/PACKAGE")
HELP2MAN         := help2man
DEPS             := @@DEPS@@
GCOVR            ?= gcovr
GCOVR_EXCLUDES   ?= --exclude 'tests/.*'
COVERAGE_CFLAGS  := --coverage -fprofile-arcs -ftest-coverage
COVERAGE_LDFLAGS := --coverage

bindir         := @@BINDIR@@
datadir        := @@DATADIR@@
datarootdir    := @@DATAROOTDIR@@
docdir         := @@DOCDIR@@
exec_prefix    := @@EXECPREFIX@@
infodir        := @@INFODIR@@
libdir         := @@LIBDIR@@
libexecdir     := @@LIBEXECDIR@@
localedir      := @@LOCALEDIR@@
localstatedir  := @@LOCALSTATEDIR@@
mandir         := @@MANDIR@@
prefix         := @@PREFIX@@
runstatedir    := @@RUNSTATEDIR@@
sbindir        := @@SBINDIR@@
sharedstatedir := @@SHAREDSTATEDIR@@
sysconfdir     := @@SYSCONFDIR@@
progprefix     := @@PROGPREFIX@@

raft_SRCS         := $(notdir $(wildcard $(srcdir)/src/raft*.c))
main_SRCS         := $(filter-out $(raft_SRCS), $(notdir $(wildcard $(srcdir)/src/*.c)))
prod_only_SRCS    := raft_impl.c

all_SRCS          := $(main_SRCS) @@EXTRASRCS@@
all_SRCS          := $(addprefix $(srcdir)/src/,$(all_SRCS))
test_SRCS              := $(wildcard $(srcdir)/tests/test_*.c)
FEATURE_RAFT           := @@FEATURE_RAFT@@
ifneq ($(FEATURE_RAFT),1)
test_SRCS              := $(filter-out $(srcdir)/tests/test_raft%.c,$(test_SRCS))
endif
raft_TEST_CORE_SRCS    := $(filter-out $(prod_only_SRCS),$(raft_SRCS))
raft_TEST_SUPPORT_SRCS := $(wildcard $(srcdir)/tests/raft_*.c)
mqtt_TEST_CORE_SRCS    := main.c constants.c

all_HEADERS       := $(wildcard $(srcdir)/include/*.h)

package_OBJS      := $(addprefix $(objdir)/,$(notdir $(all_SRCS:.c=.o)))
test_OBJS               := $(addprefix $(objdir)/tests/,$(notdir $(test_SRCS:.c=.o)))
raft_TEST_CORE_OBJS     := $(addprefix $(objdir)/,$(notdir $(raft_TEST_CORE_SRCS:.c=.test.o)))
raft_TEST_SUPPORT_OBJS  := $(addprefix $(objdir)/tests/,$(notdir $(raft_TEST_SUPPORT_SRCS:.c=.o)))
mqtt_TEST_CORE_OBJS     := $(addprefix $(objdir)/,$(notdir $(mqtt_TEST_CORE_SRCS:.c=.test.o)))

test_BINS         := $(addprefix $(objdir)/,$(notdir $(test_SRCS:.c=)))
package_BIN       := $(objdir)/$(progprefix)$(PACKAGE)
package_MAN       := $(objdir)/doc/$(progprefix)$(PACKAGE).8

comma := ,
empty :=
space := $(empty) $(empty)
comma-separate = $(subst $(space),$(comma),$(strip $1))

ifeq ($(DEPS),1)
CPPFLAGS += -MMD -MP
endif
CPPFLAGS += -I$(objdir) -I$(srcdir)/src
CPPFLAGS += -I$(srcdir)/include

.PHONY: all check test coverage coverage-run coverage-json coverage-json-run

all: $(objdir)/.d $(package_BINS) man

check: $(objdir)/tests $(objdir)/.d/tests $(test_BINS)
	@set -e; for t in $(test_BINS); do \
		echo "RUN $$t"; \
		$$t; \
	done

test: check

coverage: clean
	$(MAKE) coverage-run

coverage-run:
	$(MAKE) check \
		CFLAGS="$(CFLAGS) $(COVERAGE_CFLAGS)" \
		LDFLAGS="$(LDFLAGS) $(COVERAGE_LDFLAGS)"
	-$(MKDIR) $(objdir)/coverage/ 2>/dev/null
	$(GCOVR) -r $(srcdir) -i $(call comma-separate,$(all_SRCS)) --print-summary --xml $(objdir)/coverage/coverage.xml \
		--html-details $(objdir)/coverage/coverage.html $(GCOVR_EXCLUDES)

coverage-json: clean
	$(MAKE) coverage-json-run

coverage-json-run:
	$(MAKE) check \
		CFLAGS="$(CFLAGS) $(COVERAGE_CFLAGS)" \
		LDFLAGS="$(LDFLAGS) $(COVERAGE_LDFLAGS)"
	-$(MKDIR) $(objdir)/coverage/ 2>/dev/null
	$(GCOVR) -r $(srcdir) -i $(call comma-separate,$(all_SRCS)) --print-summary --json $(objdir)/coverage/coverage.json \
		$(GCOVR_EXCLUDES)

$(objdir)/doc:
	@mkdir -p $(objdir)/doc 2>/dev/null

$(objdir)/tests:
	@mkdir -p $(objdir)/tests 2>/dev/null

$(objdir)/.d:
	@mkdir -p $(objdir)/.d 2>/dev/null

$(objdir)/.d/tests:
	@mkdir -p $(objdir)/.d/tests 2>/dev/null

.PHONY: man

man: $(objdir)/doc/$(PACKAGE).8

$(objdir)/doc/$(PACKAGE).8: $(package_BIN) | $(objdir)/doc
	-$(HELP2MAN) -N -s 8 -S 'ZeroDay Linux' --help-option=-h --version-option=-V -o $@ $<

$(package_BIN): $(package_OBJS)
	$(CC) $^ $(LDFLAGS) -o $@

$(objdir)/test_raft%: $(objdir)/tests/test_raft%.o $(raft_TEST_CORE_OBJS) $(raft_TEST_SUPPORT_OBJS)
	$(CC) $^ $(LDFLAGS) $(CHECK_LIBS) -o $@

$(objdir)/test_mqtt%: $(objdir)/tests/test_mqtt%.o $(mqtt_TEST_CORE_OBJS)
	$(CC) $^ $(LDFLAGS) $(CHECK_LIBS) -o $@

.PHONY: install uninstall

install: $(package_BIN) man
	$(MKDIR) $(DESTDIR)$(sbindir)
	$(MKDIR) $(DESTDIR)$(localstatedir)/fail-mqttd
	-$(MKDIR) $(DESTDIR)$(mandir)/man8
	$(CP) $(package_BIN) $(DESTDIR)$(sbindir)/
	-$(CP) $(package_MAN) $(DESTDIR)$(mandir)/man8/

uninstall:
	$(RM) $(DESTDIR)$(sbindir)/$(progprefix)$(PACKAGE)
	-$(RM) $(DESTDIR)$(mandir)/man8/$(PACKAGE).8

.PHONY: mostlyclean clean distclean maintainer-clean

maintainer-clean: distclean
	$(RM) $(objdir)/config.status $(objdir)/config.log $(objdir)/config.h~

distclean: clean
	$(RM) $(objdir)/config.h $(objdir)/Makefile $(objdir)/fail-mqttd.spec \
		$(objdir)/fail-mqttd.service

mostlyclean:
	-$(RM) $(package_OBJS) $(package_BIN) $(test_OBJS) $(raft_TEST_CORE_OBJS) \
		$(raft_TEST_SUPPORT_OBJS) $(mqtt_TEST_CORE_OBJS) $(test_BINS)
	-$(RM) -f $(objdir)/*.gcda $(objdir)/*.gcno
	-$(RM) -f $(objdir)/tests/*.gcda $(objdir)/tests/*.gcno

clean: mostlyclean
	-$(RM) $(objdir)/$(doc)/$(PACKAGE).8
	-$(RM) -rf $(objdir)/.d/*
	-$(RMDIR) $(objdir)/.d

.PHONY: dist

dist: all
	( cd $(srcdir) >/dev/null ; \
	$(TAR) -Pacf $(objdir)/$(PACKAGE)-$(VERSION).tar.xz \
		--transform="s,$(objdir)/,,;s,^./,,;s,^,$(PACKAGE)-$(VERSION)/," \
		README.md COPYING src/*.c \
		tests/*.c misc Makefile.in configure \
		include/*.h SECURITY.md \
		$(PACKAGE).spec.in $(PACKAGE).service.in \
		$(objdir)/$(PACKAGE).spec $(objdir)/$(PACKAGE).service $(objdir)/doc/*.[0-9] \
	) >/dev/null

$(objdir)/%.o: $(srcdir)/src/%.c
ifeq ($(DEPS),1)
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -MF $(objdir)/.d/$*.d $< -o $@
else
	$(CC) -c $(CFLAGS) $(CPPFLAGS) $< -o $@
endif

$(objdir)/tests/%.o: $(srcdir)/tests/%.c | $(objdir)/tests
ifeq ($(DEPS),1)
	$(CC) -c $(CFLAGS) $(CPPFLAGS) $(CHECK_CFLAGS) -DTESTS -MF $(objdir)/.d/tests/$*.d $< -o $@
else
	$(CC) -c $(CFLAGS) $(CPPFLAGS) $(CHECK_CFLAGS) -DTESTS $< -o $@
endif

$(objdir)/%.test.o: $(srcdir)/src/%.c
ifeq ($(DEPS),1)
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -DTESTS -MF $(objdir)/.d/tests/$*.test.d $< -o $@
else
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -DTESTS $< -o $@
endif

ifeq ($(DEPS),1)
-include $(all_SRCS:$(srcdir)/src/%.c=$(objdir)/.d/%.d)
-include $(raft_TEST_CORE_SRCS:$(srcdir)/%.c=$(objdir)/.d/tests/%.d)
-include $(raft_TEST_SUPPORT_SRCS:$(srcdir)/tests/%.c=$(objdir)/.d/tests/%.d)
-include $(mqtt_TEST_CORE_SRCS:%.c=$(objdir)/.d/tests/%.test.d)
endif
# :vim se noexpandtab
